# The language in this case has no bearing - we are going to be making use of "conda" for a
# python distribution for the scientific python stack.
language: c

os:
  - linux
  - osx

env:
    global:
        - DESTINATION_CONDA_CHANNEL="astropy"
        - TARGET_ARCH="x64"
        - CONDA_INSTALL_LOCN="${HOME}/miniconda"

        # Defines BINSTAR_TOKEN for your binstar channel
        - secure: "2Un6RZ5ZOyJEQBAM0wJDuVY6xQYEIpV3okrP8Cuxm5bs2H9Lw1wuRS1J/NACDx4eVmD7QdC0QNSpFc4Se4kX8pLy+gKx/vwlYxPjfZ0i3LbUprzE5nARqkq6loUHlLvkUiD2szb+BcAsZXt8R9Wsj+E8rNXjzxuLSsCx2g+0XpFV+Xtr9tN0FoC7WtuuFu+QJpLqsyuU4IR+69HHFDgd7LBEZYRAvz9CNQghTd+VRWxJu1w66hRhLnngHHaDu8ngGIcQQjDyRqGefBJzRhwwxIHhra8sHRpihafPEK58eCFnwvvzZ76cyLsh80/G3iltY6aPSukwRzee0Zf1zXUWIb+0fPqo7I/7mpf/z1yp215JY+flkuNPYbOEAIs5JkDoSjp1V8ZZsYNctd9fbUUoHiGXihbJA3cRY8bIE4zcFoNiI0hi3Ik7DRRloCtccbv+zNMzZhLb6ElFc1AYc8Gg348F+xnglY88TO0qpn4AsAgfo4TjD/IVdBNo27Gw+DWkywDbLWgRDh5vbyWpfTV7+IW0o4Um7XZGNC8GppNZjoBnS16HC2MKzGA0bJHHF42oXa9erMe1aHfeEH3dIaWQh6Wvjnnk7aAwAx0CRX20IAielHIiE/sIIaIShDFCnZP4tR93JrdmET26RlRpIsPWsCTvnuyLq9KiYsmk8Gsc1aE="

        # The python build restriction MUST be set at the moment, though it
        # can have any value. The setting below avoids known-bad builds on
        # python 2.6 and 3.3 for some packages.
        - PYTHON_BUILD_RESTRICTIONS="2.7*|>=3.4"

# Matrix is fully specified (for now) by os versions

install:
    # Install and set up miniconda.
    - if [ $TRAVIS_OS_NAME == "linux" ]; then wget http://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh -O miniconda.sh; fi
    - if [ $TRAVIS_OS_NAME == "osx" ]; then wget http://repo.continuum.io/miniconda/Miniconda-latest-MacOSX-x86_64.sh -O miniconda.sh; fi
    - bash miniconda.sh -b -p $CONDA_INSTALL_LOCN
    - export PATH=${CONDA_INSTALL_LOCN}/bin:$PATH
    - conda config --set always_yes true

    - conda update --quiet conda

    # Install a couple of dependencies we need for sure.
    - conda install --quiet --yes astropy anaconda-client jinja2 cython pycrypto

    - conda config --add channels astropy
    - conda config --add channels conda-forge

    # Install obvious-ci.
    - conda install -c conda-forge obvious-ci


    # Finally, install extruder
    - conda install -c astropy extruder

    # Install custom version of conda-build for now (need to be able to pass
    # options to setup.py)
    - conda remove conda-build
    - conda install -c astropy-ci-extras conda-build=1.18.1

script:
    # Get ready to build.
    - extrude_recipes requirements.yml
    # Packages are uploaded as they are built.
    - if [[ -d recipes ]]; then obvci_conda_build_dir --build-condition="python $PYTHON_BUILD_RESTRICTIONS" recipes $DESTINATION_CONDA_CHANNEL; fi
